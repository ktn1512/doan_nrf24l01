/*
 * ina219.c
 *
 *  Created on: Jan 2, 2026
 *      Author: khanh
 */

#ifndef _INA219_H_
#define _INA219_H_

#include "main.h" // Đảm bảo main.h đã include stm32fxxx_hal.h
#include <stdint.h>
#include <stdbool.h>
#include <math.h>

// --- Defines (Giữ nguyên từ Adafruit_INA219.h) ---

#define INA219_ADDRESS (0x40) // 1000000 (A0+A1=GND)
#define INA219_READ (0x01)

/* CONFIG REGISTER (R/W) */
#define INA219_REG_CONFIG (0x00)
#define INA219_CONFIG_RESET (0x8000)

#define INA219_CONFIG_BVOLTAGERANGE_MASK (0x2000)
#define INA219_CONFIG_BVOLTAGERANGE_16V (0x0000)
#define INA219_CONFIG_BVOLTAGERANGE_32V (0x2000)

#define INA219_CONFIG_GAIN_MASK (0x1800)
#define INA219_CONFIG_GAIN_1_40MV (0x0000)
#define INA219_CONFIG_GAIN_2_80MV (0x0800)
#define INA219_CONFIG_GAIN_4_160MV (0x1000)
#define INA219_CONFIG_GAIN_8_320MV (0x1800)

#define INA219_CONFIG_BADCRES_MASK (0x0780)
#define INA219_CONFIG_BADCRES_9BIT (0x0000)
#define INA219_CONFIG_BADCRES_10BIT (0x0080)
#define INA219_CONFIG_BADCRES_11BIT (0x0100)
#define INA219_CONFIG_BADCRES_12BIT (0x0180)
#define INA219_CONFIG_BADCRES_12BIT_2S_1060US (0x0480)
#define INA219_CONFIG_BADCRES_12BIT_4S_2130US (0x0500)
#define INA219_CONFIG_BADCRES_12BIT_8S_4260US (0x0580)
#define INA219_CONFIG_BADCRES_12BIT_16S_8510US (0x0600)
#define INA219_CONFIG_BADCRES_12BIT_32S_17MS (0x0680)
#define INA219_CONFIG_BADCRES_12BIT_64S_34MS (0x0700)
#define INA219_CONFIG_BADCRES_12BIT_128S_69MS (0x0780)

#define INA219_CONFIG_SADCRES_MASK (0x0078)
#define INA219_CONFIG_SADCRES_9BIT_1S_84US (0x0000)
#define INA219_CONFIG_SADCRES_10BIT_1S_148US (0x0008)
#define INA219_CONFIG_SADCRES_11BIT_1S_276US (0x0010)
#define INA219_CONFIG_SADCRES_12BIT_1S_532US (0x0018)
#define INA219_CONFIG_SADCRES_12BIT_2S_1060US (0x0048)
#define INA219_CONFIG_SADCRES_12BIT_4S_2130US (0x0050)
#define INA219_CONFIG_SADCRES_12BIT_8S_4260US (0x0058)
#define INA219_CONFIG_SADCRES_12BIT_16S_8510US (0x0060)
#define INA219_CONFIG_SADCRES_12BIT_32S_17MS (0x0068)
#define INA219_CONFIG_SADCRES_12BIT_64S_34MS (0x0070)
#define INA219_CONFIG_SADCRES_12BIT_128S_69MS (0x0078)

#define INA219_CONFIG_MODE_MASK (0x0007)
#define INA219_CONFIG_MODE_POWERDOWN 0x00
#define INA219_CONFIG_MODE_SVOLT_TRIGGERED 0x01
#define INA219_CONFIG_MODE_BVOLT_TRIGGERED 0x02
#define INA219_CONFIG_MODE_SANDBVOLT_TRIGGERED 0x03
#define INA219_CONFIG_MODE_ADCOFF 0x04
#define INA219_CONFIG_MODE_SVOLT_CONTINUOUS 0x05
#define INA219_CONFIG_MODE_BVOLT_CONTINUOUS 0x06
#define INA219_CONFIG_MODE_SANDBVOLT_CONTINUOUS 0x07

#define INA219_REG_SHUNTVOLTAGE (0x01)
#define INA219_REG_BUSVOLTAGE (0x02)
#define INA219_REG_POWER (0x03)
#define INA219_REG_CURRENT (0x04)
#define INA219_REG_CALIBRATION (0x05)

// --- Struct Structure thay cho Class ---
typedef struct {
    I2C_HandleTypeDef *hi2c;
    uint8_t address;
    uint32_t ina219_calValue;
    uint32_t ina219_currentDivider_mA;
    float ina219_powerMultiplier_mW;
} INA219_t;

// --- Function Prototypes ---
void INA219_Init(INA219_t *ina, I2C_HandleTypeDef *hi2c, uint8_t addr);
bool INA219_Begin(INA219_t *ina);
void INA219_setCalibration_32V_2A(INA219_t *ina);
void INA219_setCalibration_32V_1A(INA219_t *ina);
void INA219_setCalibration_16V_400mA(INA219_t *ina);
float INA219_getBusVoltage_V(INA219_t *ina);
float INA219_getShuntVoltage_mV(INA219_t *ina);
float INA219_getCurrent_mA(INA219_t *ina);
float INA219_getPower_mW(INA219_t *ina);
void INA219_powerSave(INA219_t *ina, bool on);

#endif
